---
title: "STATS/CSE 780 - Homework assignment 1"
author: "Pao Zhu Vivian Hsu (Student number: 400547994)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: pdf
editor: visual
execute:
  echo: false
  warning: false
  error: false
bibliography: A1.bib
fontsize: 11pt
geometry: 
  - margin = 1in
linestretch: 1.5
---

\newpage

```{r}
## PACKAGES ##

library(tidyverse)
library(ggplot2)
library(stringi)
```

```{r}
## LOAD DATA ##

disposalDataRaw <- read_csv(file="NPRI-INRP_DisposalsEliminations_1993-present.csv", locale=locale(encoding="latin1"))
naicsCodesRaw <- read_lines("https://www23.statcan.gc.ca/imdb/p3VD.pl?Function=getVD&TVD=1369825")
```


```{r}
### DATA CLEANSING ###

## STEP 1: CLEAN NAICS CODE TO CREATE 2-DIGIT NAICS LOOKUP DATA ##
# Get 2-digit NAICS codes and their descriptions. If code ranges exist, then keep it is as is (ex. "31-33" for Manufacturing).
naicsCodes <- data.frame(x=naicsCodesRaw) %>% 
  filter(grepl("<th id=", x)) %>% 
  mutate("Sector Code (2-digit NAICS Code)" = str_match(x, "CPV=\\s*(.*?)\\s*&")[,2],
         "Sector Name" = str_match(x, '"wb-inv">\\s*(.*?)\\s*</span>')[,2]) %>% 
  select(`Sector Code (2-digit NAICS Code)`, `Sector Name`)
naicsCodes$`Sector Name` <- stri_replace_all_regex(naicsCodes$`Sector Name`, pattern = c("&#40;", "&#41;", "&#44;"), replacement = c("(", ")", ","), vectorize = F)

# Break down code ranges into their own rows
codeRangesOnly <- naicsCodes %>% 
  filter(str_length(`Sector Code (2-digit NAICS Code)`)>2) %>% 
  mutate(repStart = as.integer(str_match(`Sector Code (2-digit NAICS Code)`, "([0-9]{2})[-]([0-9]{2})")[,2]),
         repEnd = as.integer(str_match(`Sector Code (2-digit NAICS Code)`, "([0-9]{2})[-]([0-9]{2})")[,3])
  ) %>% 
  group_by(`Sector Name`) %>%
  group_modify(~ tibble("Sector Code (2-digit NAICS Code)" = seq(.$repStart, .$repEnd))) %>%
  ungroup()

# Replace any rows with code ranges with associated rows
naicsCodes <- rbind(naicsCodes, codeRangesOnly) %>% filter(str_length(`Sector Code (2-digit NAICS Code)`)==2)


## STEP 2: FILTER FOR ASBESTOS AND JOIN 2-DIGIT NAICS LOOKUP DATA ##
disposalData <- disposalDataRaw %>%
  filter(`CAS_Number / No_CAS` == "1332-21-4") %>% 
  mutate("Quantity (Tonnes)" = if_else(`Units / Unités` == "kg", `Quantity / Quantité`/1000,`Quantity / Quantité`)) %>%
  group_by(`Reporting_Year / Année`,
           `CAS_Number / No_CAS`,
           `Substance Name (English) / Nom de substance (Anglais)`,
           `NAICS / Code_SCIAN`,
           `NAICS Title / Titre Code_SCIAN`,
           `PROVINCE`) %>%
  summarize("Quantity (Tonnes)" = sum(`Quantity (Tonnes)`)) %>%
  ungroup() %>% 
  mutate("Sector Code (2-digit NAICS Code)" = substr(`NAICS / Code_SCIAN`, 1, 2)) %>% 
  left_join(naicsCodes, by = c("Sector Code (2-digit NAICS Code)" = "Sector Code (2-digit NAICS Code)")) %>% 
  select(`CAS_Number / No_CAS`,
         `Substance Name (English) / Nom de substance (Anglais)`,
         `Reporting_Year / Année`,
         `PROVINCE`,
         `NAICS / Code_SCIAN`,
         `NAICS Title / Titre Code_SCIAN`,
         `Sector Code (2-digit NAICS Code)`,
         `Sector Name`,
         `Quantity (Tonnes)`) %>% 
  rename("CAS Number" = `CAS_Number / No_CAS`,
         "Substance" = `Substance Name (English) / Nom de substance (Anglais)`,
         "Year" = `Reporting_Year / Année`,
         "Province" = `PROVINCE`,
         "Industry Code (6-digit NAICS Code)" = `NAICS / Code_SCIAN`,
         "Industry Name" = `NAICS Title / Titre Code_SCIAN`)
```


## Introduction

From the construction of ceilings to the insulation of buildings, asbestos was a highly used material before its downfall in 19XX when it was found to be toxic and associated with respiratory illness. Asbestos was subsequently banned in Canada in 19YY, but many old buildings still contain the toxin and certain industries still use it to this day because a replacement could not be found. 

The aim of this report is to explore trends in asbestos waste throughout Canada to provide direction in addressing the United Nations' Sustainable and Development Goal (SDG) 3. 

## Methods

### Data Collection
The data was sourced from Open Data Canada. The purpose of 

### Data Cleansing & Transformation
After reading the data, it was then transformed to include only asbestos data by filtering for CAS number 1332-21-4. Due to differences in measurement methods across waste processing plants, the data was converted and standardized to tonnes.

### Data Visualization 
```{r}
#| label: fig-prov-level
#| fig-cap: "Asbestos waste by year and province"
#| out-width: 50%

# Preliminary data transformation
disposalData_line <- disposalData %>% 
  group_by(`Year`,`Province`) %>%
  summarize("Quantity (Tonnes)" = sum(`Quantity (Tonnes)`))

# Plot line graph
disposalData_line %>% 
  ggplot(aes(x=`Year`, y=`Quantity (Tonnes)`, color=`Province`)) +
  geom_line()
```

```{r}
#| label: fig-country-level
#| fig-cap: "Asbestos waste across Canada by year"
#| out-width: 45%
## WASTE QUANTITY BY YEAR AGGREGATED TO COUNTRY-LEVEL ##

# Preliminary data transformation
disposalData_line <- disposalData %>% 
  group_by(`Year`) %>%
  summarize("Quantity (Tonnes)" = sum(`Quantity (Tonnes)`))

# Plot line graph
disposalData_line %>% 
  ggplot(aes(x=`Year`, y=`Quantity (Tonnes)`)) +
  geom_line()
```

## Results


## Discussion
Based on the visuals, what do you recommend ppl to do?

Where were there limitations in the study?
- Certain provinces/territories do not collect data on these substances. This could mean a couple of things - there is are no waste disposal places there, they do not report on waste quantities, or they do not track that particular substance.
- The data is measured and estimated differently by institution. While different methods could produce different amounts of variation from the true quantity, it is not a concern this is the best that can be provided. If in doubt, can look to standardize measurement techniques.

Results can be used to guide the development of stricter laws to reduce asbestos in the environment.


\newpage

## Supplementary material

###Figure 1: XYZ - Code
###Figure 2: XYZ - Code
###Figure 3: XYZ - Code

\newpage

## References
