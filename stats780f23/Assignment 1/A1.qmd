---
title: "STATS/CSE 780 - Homework assignment 1"
author: "Pao Zhu Vivian Hsu (Student number: 400547994)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: pdf
editor: visual
execute:
  echo: false
  warning: false
  error: false
bibliography: A1.bib
csl: https://www.zotero.org/styles/apa-single-spaced
fontsize: 11pt
geometry: 
  - margin = 1in
linestretch: 1.5
---

\newpage

```{r preprocessing}
# ----- PACKAGES ----- #

library(tidyverse)
library(ggplot2)
library(stringi)


# ----- LOAD DATA ----- #

disposalDataRaw <- read_csv(file="NPRI-INRP_DisposalsEliminations_1993-present.csv", 
                            locale=locale(encoding="latin1"))
naicsCodesRaw <- read_lines("https://www23.statcan.gc.ca/imdb/p3VD.pl?Function=getVD&TVD=1369825")


# ----- DATA CLEANSING ----- #

# --- Step 1: Create 2-digit NAICS code lookup table --- #
# Pull 2-digit NAICS codes / code ranges and their descriptions from the source website.
naicsCodes <- data.frame(x=naicsCodesRaw) %>% 
  filter(grepl("<th id=", x)) %>% 
  mutate("Sector Code (2-digit NAICS Code)" = str_match(x, "CPV=\\s*(.*?)\\s*&")[,2],
         "Sector Name" = str_match(x, '"wb-inv">\\s*(.*?)\\s*</span>')[,2]) %>% 
  select(`Sector Code (2-digit NAICS Code)`, `Sector Name`)
naicsCodes$`Sector Name` <- stri_replace_all_regex(naicsCodes$`Sector Name`,
                                                   pattern = c("&#40;", "&#41;", "&#44;"), 
                                                   replacement = c("(", ")", ","), 
                                                   vectorize = F)

# Break code ranges down to their own rows
codeRangesOnly <- naicsCodes %>% 
  filter(str_length(`Sector Code (2-digit NAICS Code)`)>2) %>% 
  mutate(repStart = as.integer(str_match(`Sector Code (2-digit NAICS Code)`,
                                         "([0-9]{2})[-]([0-9]{2})")[,2]),
         repEnd = as.integer(str_match(`Sector Code (2-digit NAICS Code)`,
                                       "([0-9]{2})[-]([0-9]{2})")[,3])
  ) %>% 
  group_by(`Sector Name`) %>%
  group_modify(~ tibble("Sector Code (2-digit NAICS Code)" = 
                          seq(.$repStart, .$repEnd))) %>%
  ungroup()

# Replace rows with code ranges with the broken down rows
naicsCodes <- rbind(naicsCodes, codeRangesOnly) %>% 
  filter(str_length(`Sector Code (2-digit NAICS Code)`)==2)

# --- Step 2: Filter disposal data for asbestos and join 2-digit naics codes --- # 
disposalData <- disposalDataRaw %>%
  filter(`CAS_Number / No_CAS` == "1332-21-4") %>% 
  mutate("Quantity (Tonnes)" = if_else(`Units / Unités` == "kg",
                                       `Quantity / Quantité`/1000,
                                       `Quantity / Quantité`),
         "Sector Code (2-digit NAICS Code)" = substr(`NAICS / Code_SCIAN`, 1, 2)) %>% 
  left_join(naicsCodes,
            by = c("Sector Code (2-digit NAICS Code)" = 
                     "Sector Code (2-digit NAICS Code)")) %>% 
  group_by(`Reporting_Year / Année`,
           `PROVINCE`,
           `Sector Code (2-digit NAICS Code)`,
           `Sector Name`) %>%
  summarize("Quantity (Tonnes)" = sum(`Quantity (Tonnes)`)) %>%
  ungroup() %>% 
  rename("Year" = `Reporting_Year / Année`,
         "Province" = `PROVINCE`)


# ----- SAVE DATA FOR SHINY ----- #

save(disposalData, file="shiny/disposalData.RData")

```


## Introduction

Asbestos was a common construction material prior to the 1990s that was later found to be linked to diseases such as lung cancer and asbestosis [@asbestosHealth]. Although it was banned in 2018, asbestos is still prevalent in old buildings and actively used in the military, nuclear, and chlor-alkali industries in Canada [@ban2018laws]. This report examines asbestos waste and identifies key sectors that provinces can target to further reduce the toxin from the environment.


## Methods
To begin the study, disposal data was downloaded from the Open Government Portal [@disposalData] and filtered to only asbestos waste using its Chemical Abstracts Service (CAS) number, 1332-21-4 [@]. While the original data consisted of 17 variables (see Supplementary Materials for details), only the year, province, North American Industry Classification System (NAICS) code, and quantity of waste were important for the aim of this study. The first two digits of the NAICS code were mapped to sector names using data scraped from the Statistics Canada website [@naicsData]. This reduces the complexity of the original industry variables and allows for a high-level analysis later in the study. All quantities were converted to tonnes to standardize differences in measurement methods and the data was then aggregated by year, province, and sector to eliminate unused variables. Finally, three line graphs were created to examine the trends by province, aggregated to all of Canada, and by sectors specific to provinces. All analyses were done using R [@citeR] and the last plot was created using Shiny [@citeShiny].


## Results

```{r}
#| label: fig-prov-level
#| fig-cap: "Asbestos waste by year and province"
#| out-width: 60%

# ----- FIGURE 1 ----- #

# Preliminary data transformation
disposalData_fig1 <- disposalData %>% 
  group_by(`Year`,`Province`) %>%
  summarize("Quantity (Tonnes)" = sum(`Quantity (Tonnes)`))

# Plot line graph
disposalData_fig1 %>% 
  ggplot(aes(x=`Year`, y=`Quantity (Tonnes)`, color=`Province`)) +
  geom_line() + 
  scale_x_continuous(breaks = round(seq(min(disposalData_fig1$`Year`), 
                                        max(disposalData_fig1$`Year`), by = 4),1))

```

```{r}
#| label: fig-country-level
#| fig-cap: "Asbestos waste across Canada by year"
#| out-width: 50%
# ----- FIGURE 2 ----- #

# Preliminary data transformation
disposalData_fig2 <- disposalData %>% 
  group_by(`Year`) %>%
  summarize("Quantity (Tonnes)" = sum(`Quantity (Tonnes)`))

# Plot line graph
disposalData_fig2 %>% 
  ggplot(aes(x=`Year`, y=`Quantity (Tonnes)`)) +
  geom_line() +
  scale_x_continuous(breaks = round(seq(min(disposalData_fig2$`Year`), 
                                        max(disposalData_fig2$`Year`), by = 4),1))

```

https://1b5hyx-pao0zhu0vivian0-hsu.shinyapps.io/shiny/

## Discussion

Based on the visuals, what do you recommend ppl to do?

Where were there limitations in the study? - Certain provinces/territories do not collect data on these substances. This could mean a couple of things - there is are no waste disposal places there, they do not report on waste quantities, or they do not track that particular substance. - The data is measured and estimated differently by institution. While different methods could produce different amounts of variation from the true quantity, it is not a concern this is the best that can be provided. If in doubt, can look to standardize measurement techniques.

Results can be used to guide the development of stricter laws to reduce asbestos in the environment.

- As a whole, Canada's asbestos waste has been trending 

\newpage

## Supplementary material

### Report Code
```{r report-code, ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

### Shiny App Code
```{r shiny-code, file="shiny/app.r", echo=TRUE, eval=FALSE}
```


\newpage

## References
::: {#refs} 
:::
